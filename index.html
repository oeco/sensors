<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="../dist/leaflet.css" />
</head>
<body>
	<div id="map" style="width: 600px; height: 400px"></div>

	<script src="../dist/jquery-1.11.1.min.js"></script>
	<script src="../dist/underscore-min.js"></script>	
	<script src="../dist/async.js"></script>	
	<script src="../dist/leaflet.js"></script>

	<script>
		var map = L.map('map').setView([-14.82,-49.09515], 4);
		var xively_endpoint = "https://api.xively.com/v2/feeds/";
		var sensors_geojson;

		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		var fetchSensorData = function(feed_id, x_apikey, callback) {
			$.ajax({
				url: xively_endpoint+feed_id,
				type: 'GET',
				dataType: 'json',
				beforeSend: function(request) {
					request.setRequestHeader("X-ApiKey", x_apikey);
				},
				success: function(data) { callback(null, data) },
				error: function(err) { callback(err) }
			});
		}

		$.getJSON("sensors.geojson", function(geojson) {

			var features = [];

			async.each(geojson.features, function(f, callback){
				fetchSensorData(f.properties['feed_id'], f.properties['X-ApiKey'], function(err,data){
					f.properties = _.extend(f.properties, data);
					features.push(f);
					callback();
				});
			}, function(err){
				geojson.features = features;
				console.log(features);
				L.geoJson(geojson,{
					style: function(feature) {
						switch (feature.properties.party) {
							case 'Republican': return {color: "#ff0000"};
							case 'Democrat':   return {color: "#0000ff"};
						}
					},
					onEachFeature: function (feature, layer) {
						var popupContent = 
								"<p>"+feature.properties.title+"<p>" +
								"<p>PM10: "+feature.properties.datastreams[0].current_value+"<p>" +
								"<p>PM2.5: "+feature.properties.datastreams[2].current_value+"<p>";

						layer.bindPopup(popupContent);
					}
				}).addTo(map);
			});
		});


	</script>
</body>
</html>
